apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: s3-bucket-pessoal-aprovacao
  title: AWS S3 com PR e Aprova√ß√£o
  description: Cria um PR para infraestrutura S3. A aprova√ß√£o ocorre no GitHub.
  tags:
    - aws
    - s3
    - infra
spec:
  owner: team-devops
  type: service

  # 1. Par√¢metros de entrada do usu√°rio
  parameters:
    - title: Configura√ß√µes do Bucket
      required: [name, owner_team]
      properties:
        name:
          title: Nome do Bucket S3
          type: string
          description: Nome √∫nico do bucket (ex: meu-bucket-logs)
          ui:autofocus: true
        
        owner_team:
          title: Time Respons√°vel
          type: string
          description: Quem ser√° o dono deste recurso?
          enum:
            - team-devops
            - team-engenharia
            - team-gerencia
          default: team-devops

  # 2. O que o Backstage vai fazer
  steps:
    - id: fetch-base
      name: Gerar Arquivos Terraform/Infra
      action: fetch:template
      input:
        url: ./content # Certifique-se que esta pasta existe no seu repo com algum arquivo (ex: main.tf)
        values:
          name: ${{ parameters.name }}
          owner: ${{ parameters.owner_team }}

    # Simula√ß√£o de Logs para o usu√°rio ver o progresso
    - id: log-policy
      name: Validando Pol√≠ticas de Seguran√ßa
      action: debug:log
      input:
        message: "Aplicando tags de custo e valida√ß√£o para ${{ parameters.owner_team }}"

    # 3. Publicar via Pull Request (Aqui acontece a m√°gica da aprova√ß√£o)
    - id: publish-pr
      name: Criar Pull Request de Aprova√ß√£o
      action: publish:github:pull-request
      input:
        repoUrl: github.com?repo=infra-pessoal&owner=tales-andre
        branchName: feature/s3-${{ parameters.name }}
        title: "Infra: Cria√ß√£o do Bucket ${{ parameters.name }}"
        description: |
          # Solicita√ß√£o de Novo Bucket S3
          
          **Recurso:** ${{ parameters.name }}
          **Solicitante:** ${{ user.ref }}
          **Time:** ${{ parameters.owner_team }}

          ## Aprova√ß√µes Necess√°rias
          Este PR requer aprova√ß√£o dos seguintes grupos antes do merge:
          - [ ] DevOps
          - [ ] Engenharia
        
        # Opcional: Se quiser for√ßar reviewers via template (mas o ideal √© usar CODEOWNERS no repo)
        # reviewers: 
        #   - usuario-do-chefe

    # 4. Registrar no Cat√°logo (Opcional, s√≥ funciona se o arquivo catalog-info.yaml for gerado)
    # - id: register
    #   name: Registrar no Backstage
    #   action: catalog:register
    #   input:
    #     repoContentsUrl: ${{ steps['publish-pr'].output.remoteUrl }}
    #     catalogInfoPath: '/catalog-info.yaml'

  # 5. O que mostrar pro usu√°rio no final
  output:
    links:
      - title: üöÄ Acessar Pull Request para Aprova√ß√£o
        url: ${{ steps['publish-pr'].output.remoteUrl }}
      - title: üìÇ Ver Reposit√≥rio
        url: https://github.com/tales-andre/infra-pessoal
