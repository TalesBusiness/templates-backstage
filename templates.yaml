apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: s3-bucket-pessoal-aprovacao
  title: "AWS S3 com PR e Aprova√ß√£o"
  description: "Cria um PR para infraestrutura S3."
  tags:
    - aws
    - s3
  annotations:
    github.com/project-slug: tales-andre/templates-backstage
spec:
  owner: team-devops
  type: service

  parameters:
    - title: "Configura√ß√µes do Bucket"
      required: [name, owner_team]
      properties:
        name:
          title: "Nome do Bucket S3"
          type: string
          description: "Nome √∫nico do bucket (ex: meu-bucket-logs)" # ‚úÖ Aspas adicionadas aqui
          ui:autofocus: true
        
        owner_team:
          title: "Time Respons√°vel"
          type: string
          description: "Quem ser√° o dono deste recurso?"
          enum:
            - team-devops
            - team-engenharia
            - team-gerencia
          default: team-devops

  steps:
    - id: fetch-base
      name: Gerar Arquivos Terraform
      action: fetch:template
      input:
        url: ./content 
        values:
          name: ${{ parameters.name }}
          owner: ${{ parameters.owner_team }}

    - id: log-policy
      name: Validando Pol√≠ticas
      action: debug:log
      input:
        message: "Aplicando tags para ${{ parameters.owner_team }}"

    - id: publish-pr
      name: Criar Pull Request
      action: publish:github:pull-request
      input:
        repoUrl: github.com?repo=infra-pessoal&owner=tales-andre
        branchName: feature/s3-${{ parameters.name }}
        title: "Infra: Cria√ß√£o do Bucket ${{ parameters.name }}"
        description: |
          # Solicita√ß√£o de Novo Bucket S3
          **Recurso:** ${{ parameters.name }}
          **Solicitante:** ${{ user.ref }}
        
    # Se quiser registrar automaticamente depois do merge, descomente abaixo:
    # - id: register
    #   name: Registrar no Backstage
    #   action: catalog:register
    #   input:
    #     repoContentsUrl: ${{ steps['publish-pr'].output.remoteUrl }}
    #     catalogInfoPath: '/catalog-info.yaml'

  output:
    links:
      - title: "üöÄ Acessar Pull Request"
        url: ${{ steps['publish-pr'].output.remoteUrl }}
      - title: "üìÇ Ver Reposit√≥rio"
        url: https://github.com/tales-andre/infra-pessoal
