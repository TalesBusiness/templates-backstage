apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: sqs-sns-pessoal-aprovacao
  title: "AWS SQS+SNS com PR e Aprova√ß√£o"
  description: "Cria um PR para infraestrutura Pub/Sub (SQS/SNS)."
  tags:
    - aws
    - sqs
    - sns
  annotations:
    github.com/project-slug: TalesBusiness/infra-pessoal
spec:
  owner: team-devops
  type: service

  parameters:
    - title: "Configura√ß√µes do Recurso"
      required: [component_id, region]
      properties:
        component_id:
          title: "Nome do Recurso"
          type: string
          description: "Nome base para a Fila e o T√≥pico (ex: pagamentos-events)"
          ui:autofocus: true
        
        region:
          title: "Regi√£o AWS"
          type: string
          description: "Regi√£o onde o recurso ser√° criado"
          enum:
            - us-east-1
            - sa-east-1
          default: us-east-1

  steps:
    - id: fetch-base
      name: Gerar Arquivos Terraform
      action: fetch:template
      input:
        # ‚ö†Ô∏è SE O TEMPLATE EST√Å DENTRO DA PASTA JUNTO COM O MAIN.TF, USE "./"
        # SE O TEMPLATE EST√Å NA RAIZ, USE "./skeleton-sqs-sns"
        url: ./skeleton-sqs-sns 
        
        # ‚úÖ ADICIONE ISSO: Cria uma pasta separada para n√£o misturar arquivos
        targetPath: ./infra/sqs-${{ parameters.component_id }}
        
        values:
          component_id: ${{ parameters.component_id }}
          region: ${{ parameters.region }}

    - id: log-policy
      name: Validando Par√¢metros
      action: debug:log
      input:
        message: "Iniciando provisionamento de ${{ parameters.component_id }} em ${{ parameters.region }}"

    - id: publish-pr
      name: Criar Pull Request
      action: publish:github:pull-request
      input:
        repoUrl: github.com?repo=infra-pessoal&owner=TalesBusiness
        branchName: feature/sqs-${{ parameters.component_id }}
        title: "Infra: Cria√ß√£o SQS/SNS ${{ parameters.component_id }}"
        description: |
          # Solicita√ß√£o de Provisionamento Pub/Sub
          
          **Recurso:** ${{ parameters.component_id }}
          **Regi√£o:** ${{ parameters.region }}
          
          **Solicitante:** @${{ user.entity.metadata.name }}

  output:
    links:
      - title: "üöÄ Acessar Pull Request"
        url: ${{ steps['publish-pr'].output.remoteUrl }}
      - title: "üìÇ Ver Reposit√≥rio"
        url: https://github.com/TalesBusiness/infra-pessoal
