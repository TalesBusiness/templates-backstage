apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: sqs-sns-pessoal-aprovacao
  title: "AWS SQS+SNS com PR e Aprova칞칚o"
  description: "Cria um PR para infraestrutura Pub/Sub (SQS/SNS)."
  tags:
    - aws
    - sqs
    - sns
  annotations:
    github.com/project-slug: TalesBusiness/infra-pessoal
spec:
  owner: team-devops
  type: service

  parameters:
    - title: "Configura칞칫es do Recurso"
      required: [component_id, region]
      properties:
        component_id:
          title: "Nome do Recurso"
          type: string
          description: "Nome base para a Fila e o T칩pico (ex: pagamentos-events)"
          ui:autofocus: true
        
        region:
          title: "Regi칚o AWS"
          type: string
          description: "Regi칚o onde o recurso ser치 criado"
          enum:
            - us-east-1
            - sa-east-1
          default: us-east-1

  steps:
    - id: fetch-base
      name: Gerar Arquivos Terraform
      action: fetch:template
      input:
        # 游릭 CORRE칂츾O CR칈TICA:
        # Como o template.yaml e o main.tf est칚o na MESMA pasta, usamos "./"
        url: ./
        
        # 游릭 ORGANIZA칂츾O:
        # Define onde salvar no repo de destino (infra-pessoal) para n칚o misturar arquivos
        targetPath: ./sqs-${{ parameters.component_id }}
        
        values:
          component_id: ${{ parameters.component_id }}
          region: ${{ parameters.region }}

    - id: log-policy
      name: Validando Par칙metros
      action: debug:log
      input:
        message: "Iniciando provisionamento de ${{ parameters.component_id }} em ${{ parameters.region }}"

    - id: publish-pr
      name: Criar Pull Request
      action: publish:github:pull-request
      input:
        repoUrl: github.com?repo=infra-pessoal&owner=TalesBusiness
        branchName: feature/sqs-${{ parameters.component_id }}
        title: "Infra: Cria칞칚o SQS/SNS ${{ parameters.component_id }}"
        description: |
          # Solicita칞칚o de Provisionamento Pub/Sub
          
          **Recurso:** ${{ parameters.component_id }}
          **Regi칚o:** ${{ parameters.region }}
          
          **Solicitante:** @${{ user.entity.metadata.name }}

  output:
    links:
      - title: "游 Acessar Pull Request"
        url: ${{ steps['publish-pr'].output.remoteUrl }}
      - title: "游늭 Ver Reposit칩rio"
        url: https://github.com/TalesBusiness/infra-pessoal
